{% extends "base.html" %}

{% block title %}{{ 'Editar' if book else 'Crear' }} Libro{% endblock %}

{% block content %}
<div class="d-flex">
    {% include 'components/admin_panel.html' %}

    <!-- Main Content -->
    <div class="flex-grow-1 p-4">
        <div class="container-fluid">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1">
                        <i class="bi bi-{{ 'pencil-square' if book else 'plus-square' }} me-2 text-primary"></i>
                        {{ 'Editar' if book else 'Nuevo' }} Libro
                    </h2>
                    <p class="text-muted mb-0">
                        {{ 'Modifica la informaci칩n del libro' if book else 'Completa la informaci칩n del nuevo libro' }}
                    </p>
                </div>
                <a href="{{ url_for('admin.dashboard') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i>
                    Volver
                </a>
            </div>

            <!-- Estad칤sticas de Propuesta -->
            <div class="card shadow-sm mb-4 stats-card">
                <div class="card-body">
                    <div class="row g-4">
                        <!-- Estado -->
                        <div class="col-md-3">
                            <div class="stat-item">
                                <div class="stat-icon bg-primary bg-opacity-10 text-primary px-2">
                                    <i class="bi bi-flag-fill"></i>
                                    {{ book.status }}
                                </div>
                                <div class="stat-content">
                                    <small class="text-muted d-block">Estado</small>
                                </div>
                            </div>
                        </div>

                        <!-- Libros a Publicar -->
                        <div class="col-md-3">
                            <div class="stat-item">
                                <div class="stat-icon bg-info bg-opacity-10 text-info px-2">
                                    <i class="bi bi-book-fill"></i>
                                    {{ book.published_books if book.published_books else 0 }}
                                </div>
                                <div class="stat-content">
                                    <small class="text-muted d-block">Libros a Publicar</small>
                                </div>
                            </div>
                        </div>

                        <!-- Porcentaje de Ganancia -->
                        <div class="col-md-3">
                            <div class="stat-item">
                                <div class="stat-icon bg-warning bg-opacity-10 text-warning px-2">
                                    <i class="bi bi-percent"></i>
                                    {{ book.profit_percentage if book.profit_percentage else 'N' }}
                                </div>
                                <div class="stat-content">
                                    <small class="text-muted d-block">Ganancia por Venta</small>
                                </div>
                            </div>
                        </div>

                        <!-- Ganancias Esperadas -->
                        <div class="col-md-3">
                            <div class="stat-item">
                                <div class="stat-icon bg-success bg-opacity-10 text-success px-2">
                                    <i class="bi bi-currency-dollar"></i>
                                    {{ book.get_profit * book.published_books if book.published_books and book.profit_percentage }}
                                </div>
                                <div class="stat-content">
                                    <small class="text-muted d-block">Ganancias Esperadas</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Formulario Principal -->
                <div class="col-lg-8">
                    <form method="POST" enctype="multipart/form-data">
                        <div class="card shadow-sm mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">Informaci칩n General</h5>
                            </div>
                            <div class="card-body">
                                <!-- T칤tulo -->
                                <div class="mb-3">
                                    <label for="title" class="form-label fw-semibold">
                                        T칤tulo <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" 
                                           class="form-control form-control-lg" 
                                           id="title"
                                           name="title" 
                                           value="{{ book.title if book else '' }}" 
                                           placeholder="Ej: El Principito"
                                           {% if current_user.type == 'editor' %}disabled{% endif %}
                                           required>
                                </div>

                                <!-- Descripci칩n -->
                                <div class="mb-3">
                                    <label for="description" class="form-label fw-semibold">
                                        Descripci칩n
                                    </label>
                                    <textarea class="form-control" 
                                              id="description"
                                              name="description" 
                                              rows="5"
                                              placeholder="Escribe una descripci칩n atractiva del libro..."
                                              {% if current_user.type == 'editor' %}disabled{% endif %}
                                            >{{ book.description if book else '' }}</textarea>
                                    <div class="form-text">Una buena descripci칩n ayuda a los lectores a descubrir tu libro.</div>
                                </div>

                                <div class="mb-3">
                                    <label for="genre" class="form-label fw-semibold">
                                        Genero
                                    </label>
                                    <select class="form-select" 
                                            id="genre" 
                                            name="genre"
                                            {% if current_user.type == 'editor' %}disabled{% endif %}>
                                        <option value="">Ninguno</option>
                                        {% for value, data in genres.items() %}
                                            <option value="{{ value }}" {% if book and book.genre == value %}selected{% endif %}>
                                                {{ data.label }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <!-- Precio y P치ginas en fila -->
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="price" class="form-label fw-semibold">
                                            Precio (ARS) <span class="text-danger">*</span>
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            <input type="number" 
                                                   class="form-control" 
                                                   id="price"
                                                   name="price" 
                                                   value="{{ book.price if book else '15000.0' }}"
                                                   step="100"
                                                   min="5000"
                                                   placeholder="15000.0"
                                                   {% if current_user.type == 'editor' %}disabled{% endif %}
                                                   required>
                                        </div>
                                    </div>

                                    <div class="col-md-6 mb-3">
                                        <label for="pages" class="form-label fw-semibold">
                                            P치ginas <span class="text-danger">*</span>
                                        </label>
                                        <input type="number" 
                                               class="form-control" 
                                               id="pages"
                                               name="pages" 
                                               value="{{ book.pages if book else '' }}" 
                                               placeholder="250"
                                               min="1"
                                               {% if current_user.type == 'editor' %}disabled{% endif %}
                                               required>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Portada -->
                        <div class="card shadow-sm mb-4">
                            <div class="card-header bg-white">
                                <h5 class="mb-0">Portada del Libro</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-8">
                                        <label for="cover" class="form-label fw-semibold">
                                            Imagen de portada
                                        </label>
                                        <input type="file" 
                                               class="form-control" 
                                               id="cover"
                                               name="cover" 
                                               accept="image/*"
                                               {% if current_user.type == 'editor' %}disabled{% endif %}>
                                        <div class="form-text">
                                            <i class="bi bi-info-circle me-1"></i>
                                            JPG, PNG o GIF. Tama침o recomendado: 600x900px. M치ximo: 5MB
                                        </div>
                                    </div>
                                    
                                    <!-- Preview de portada actual -->
                                    {% if book and book.cover_url %}
                                    <div class="col-md-4">
                                        <p class="text-muted mb-2 small">Vista previa actual:</p>
                                        <img src="{{ book.cover_url }}" 
                                             alt="Portada actual" 
                                             class="img-fluid rounded shadow-sm"
                                             style="max-height: 200px; object-fit: cover;">
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Botones de acci칩n fijos al fondo -->
                        {% if current_user.type != 'editor' %}
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <div class="d-flex gap-2 justify-content-between align-items-center">
                                    <small class="text-muted">
                                        <i class="bi bi-asterisk text-danger"></i>
                                        Campos requeridos
                                    </small>
                                    <div class="d-flex gap-2">
                                        <a href="{{ url_for('admin.dashboard') }}" class="btn btn-outline-secondary">
                                            <i class="bi bi-x-lg me-1"></i>
                                            Cancelar
                                        </a>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="bi bi-{{ 'save' if book else 'plus-lg' }} me-1"></i>
                                            {{ 'Actualizar Libro' if book else 'Publicar Libro' }}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </form>
                </div>

                {% if current_user.type == 'escritor' %}
                <!-- Panel lateral con informaci칩n -->
                <div class="col-lg-4">
                    <div class="card shadow-sm sticky-top" style="top: 20px;">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="bi bi-lightbulb me-2"></i>
                                Consejos
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <h6 class="fw-bold">九꽲잺 T칤tulo atractivo</h6>
                                <p class="small text-muted mb-0">Elige un t칤tulo memorable que capte la atenci칩n de los lectores.</p>
                            </div>
                            <hr>
                            <div class="mb-3">
                                <h6 class="fw-bold">游닀 Descripci칩n completa</h6>
                                <p class="small text-muted mb-0">Incluye el g칠nero, temas principales y qu칠 hace 칰nico a tu libro.</p>
                            </div>
                            <hr>
                            <div class="mb-3">
                                <h6 class="fw-bold">游꿛 Portada profesional</h6>
                                <p class="small text-muted mb-0">Una buena portada puede aumentar tus ventas hasta un 40%.</p>
                            </div>
                            <hr>
                            <div>
                                <h6 class="fw-bold">游눯 Precio competitivo</h6>
                                <p class="small text-muted mb-0">El precio promedio de e-books est치 entre $2.99 y $9.99.</p>
                            </div>
                        </div>
                        <div class="card-footer bg-light">
                            <small class="text-muted">
                                <i class="bi bi-question-circle me-1"></i>
                                쯅ecesitas ayuda? <a href="#" class="text-decoration-none">Cont치ctanos</a>
                            </small>
                        </div>
                    </div>
                </div>
                {% else %}
                <!-- Panel lateral administrativo (para editores) -->
                <div class="col-lg-4">
                    <form method="POST" action="{{ url_for('admin.edit', id=book.id) }}">
                        <div class="card shadow-sm sticky-top" style="top: 20px;">
                            <div class="card-header bg-light d-flex align-items-center justify-content-between">
                                <h6 class="mb-0">
                                    <i class="bi bi-gear-fill me-2"></i>
                                    Configuraci칩n Editorial
                                </h6>
                                <span class="badge bg-secondary">Solo editores</span>
                            </div>

                            <div class="card-body">
                                <!-- Estado -->
                                <div class="mb-3">
                                    <label for="status" class="form-label fw-semibold">Estado del libro</label>
                                    <select id="status" name="status" class="form-select" required>
                                        <option value="pendiente" {% if book.status == 'pendiente' %}selected{% endif %}>Pendiente</option>
                                        <option value="revisi칩n" {% if book.status == 'revisi칩n' %}selected{% endif %}>En revisi칩n</option>
                                        <option value="aprobado" {% if book.status == 'aprobado' %}selected{% endif %}>Aprobado</option>
                                        <option value="rechazado" {% if book.status == 'rechazado' %}selected{% endif %}>Rechazado</option>
                                        <option value="publicado" {% if book.status == 'publicado' %}selected{% endif %}>Publicado</option>
                                    </select>
                                </div>

                                <!-- Libros a publicar -->
                                <div class="mb-3">
                                    <label for="books_to_publish" class="form-label fw-semibold">Libros a publicar</label>
                                    <input type="number"
                                        id="books_to_publish"
                                        name="books_to_publish"
                                        class="form-control"
                                        value="{{ book.published_books if book.published_books else 0 }}"
                                        min="0"
                                        required>
                                    <div class="form-text">Define cu치ntas copias ser치n lanzadas inicialmente.</div>
                                </div>

                                <!-- Porcentaje de ganancia -->
                                <div class="mb-3">
                                    <label for="profit_percentage" class="form-label fw-semibold">Porcentaje de ganancia</label>
                                    <div class="input-group">
                                        <input type="number"
                                            id="profit_percentage"
                                            name="profit_percentage"
                                            class="form-control"
                                            step="1"
                                            min="0"
                                            max="100"
                                            required
                                            value="{{ book.profit_percentage if book.profit_percentage else 20 }}">
                                        <span class="input-group-text">%</span>
                                    </div>
                                    <div class="form-text">Margen de ganancia del autor por venta.</div>
                                </div>
                            </div>

                            <div class="card-footer bg-light d-flex justify-content-between align-items-center">
                                <small class="text-muted">
                                    <i class="bi bi-shield-lock me-1"></i>
                                    Solo los editores pueden modificar estos valores.
                                </small>
                                <button type="submit" class="btn btn-primary btn-sm">
                                    <i class="bi bi-save me-1"></i>Guardar
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
    .card {
        border: none;
        border-radius: 12px;
    }
    
    .card-header {
        border-radius: 12px 12px 0 0 !important;
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }
    
    .form-control:focus, .form-control-lg:focus {
        border-color: var(--bs-primary);
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
    }

    /* Estilo para campos deshabilitados */
    .form-control:disabled,
    .form-select:disabled {
        background-color: #f8f9fa;
        opacity: 0.7;
        cursor: not-allowed;
    }
</style>
{% endblock %}